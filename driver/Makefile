CXX ?= g++
CXXFLAGS ?= -std=c++17 -Wall -Wextra -O2
BUILD_DIR ?= $(abspath ../build)

BACKEND_DIRS := $(filter-out ../backends/common/ ../backends/_template/ ../backends/ext/ ../backends/tests/,$(wildcard ../backends/*/ ../backends/ext/*/))
BACKEND_NAMES := $(sort $(notdir $(patsubst %/,%,$(BACKEND_DIRS))))
backend_dir = $(firstword $(filter %/$1/,$(BACKEND_DIRS)))
BACKEND_HEADERS := $(foreach name,$(BACKEND_NAMES),$(call backend_dir,$(name))src/$(name)_backend.h)
BACKEND_INCLUDES := $(foreach dir,$(BACKEND_DIRS),-I$(dir)src)

CXXFLAGS += -Isrc -I../frontend/src $(BACKEND_INCLUDES)

BIN = $(BUILD_DIR)/vexel
FRONTEND_LIB = $(BUILD_DIR)/lib/libvexelfrontend.a
BACKEND_LIBS = $(foreach name,$(BACKEND_NAMES),$(BUILD_DIR)/backends/$(name)/libvexel-$(name).a)

SOURCES = $(wildcard src/*.cpp)
OBJECTS = $(patsubst src/%.cpp,$(BUILD_DIR)/driver/%.o,$(SOURCES))
AUTO_REGISTER = $(BUILD_DIR)/driver/autoregister.cpp
AUTO_REGISTER_OBJ = $(BUILD_DIR)/driver/autoregister.o
OBJECTS += $(AUTO_REGISTER_OBJ)

.PHONY: all clean test

all: $(BIN)

test:
	@echo "No tests defined for driver yet."

$(BIN): $(OBJECTS) $(FRONTEND_LIB) $(BACKEND_LIBS)
	@mkdir -p $(@D)
	$(CXX) $(CXXFLAGS) $(OBJECTS) -Wl,--start-group $(BACKEND_LIBS) $(FRONTEND_LIB) -Wl,--end-group -o $@

$(BUILD_DIR)/driver/%.o: src/%.cpp
	@mkdir -p $(@D)
	$(CXX) $(CXXFLAGS) -MMD -MP -c $< -o $@

$(AUTO_REGISTER): $(BACKEND_HEADERS) Makefile
	@mkdir -p $(@D)
	@{ \
	  echo "/* Auto-generated by driver/Makefile. */"; \
	  echo "#include \"backend_registry.h\""; \
	  for name in $(BACKEND_NAMES); do \
	    echo "#include \"$$name""_backend.h\""; \
	  done; \
	  echo "namespace { struct AutoRegister { AutoRegister() {"; \
	  for name in $(BACKEND_NAMES); do \
	    echo "  vexel::register_backend_$$name();"; \
	  done; \
	  echo "} }; static AutoRegister auto_register; }"; \
	} > "$@"

$(AUTO_REGISTER_OBJ): $(AUTO_REGISTER)
	@mkdir -p $(@D)
	$(CXX) $(CXXFLAGS) -MMD -MP -c $< -o $@

clean:
	rm -f $(OBJECTS)
	rm -f $(OBJECTS:.o=.d)
	rm -f $(AUTO_REGISTER)
	rm -f $(BIN)
	rmdir --ignore-fail-on-non-empty $(BUILD_DIR)

-include $(OBJECTS:.o=.d)
