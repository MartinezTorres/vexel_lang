VEXEL_ROOT_DIR ?= $(abspath ..)
OUT_DIR ?= $(abspath .)
DOCS_DIR ?= $(VEXEL_ROOT_DIR)/docs
EMXX ?= em++

rwildcard = $(wildcard $1$2) $(foreach d,$(wildcard $1*),$(call rwildcard,$d/,$2))

BACKEND_DIRS := $(filter-out $(VEXEL_ROOT_DIR)/backends/common/ $(VEXEL_ROOT_DIR)/backends/ext/ $(VEXEL_ROOT_DIR)/backends/tests/,$(wildcard $(VEXEL_ROOT_DIR)/backends/*/ $(VEXEL_ROOT_DIR)/backends/ext/*/))
BACKEND_NAMES := $(sort $(notdir $(patsubst %/,%,$(BACKEND_DIRS))))
backend_dir = $(firstword $(filter %/$1/,$(BACKEND_DIRS)))
BACKEND_HEADERS := $(foreach name,$(BACKEND_NAMES),$(call backend_dir,$(name))src/$(name)_backend.h)
BACKEND_SOURCES := $(foreach dir,$(BACKEND_DIRS),$(filter-out $(dir)src/%_main.cpp,$(wildcard $(dir)src/*.cpp)))
BACKEND_INCLUDES := $(foreach dir,$(BACKEND_DIRS),-I$(dir)src)
AUTO_REGISTER := $(VEXEL_ROOT_DIR)/build/playground/autoregister.cpp
FRONTEND_INCLUDE_DIRS := $(shell find $(VEXEL_ROOT_DIR)/frontend/src -type d -print)
FRONTEND_SOURCES := $(sort $(filter-out $(VEXEL_ROOT_DIR)/frontend/src/cli/frontend_main.cpp,$(call rwildcard,$(VEXEL_ROOT_DIR)/frontend/src/,*.cpp)))

SOURCES := \
  $(FRONTEND_SOURCES) \
  $(BACKEND_SOURCES) \
  $(AUTO_REGISTER) \
  $(VEXEL_ROOT_DIR)/playground/web_main.cpp

INCLUDES := \
  -I$(VEXEL_ROOT_DIR) \
  $(addprefix -I,$(FRONTEND_INCLUDE_DIRS)) \
  $(BACKEND_INCLUDES)

EMXXFLAGS ?= -std=c++17 -O2 -fexceptions
EMFLAGS := \
  -s FORCE_FILESYSTEM=1 \
  -s MODULARIZE=1 \
  -s EXPORT_NAME='createVexelModule' \
  -s EXPORTED_RUNTIME_METHODS='["FS","callMain"]' \
  -s ALLOW_MEMORY_GROWTH=1 \
  -s ENVIRONMENT='web' \
  -s DISABLE_EXCEPTION_CATCHING=0 \
  -Wl,--export=__main_argc_argv

TARGET := $(OUT_DIR)/vexel.js
WASM := $(OUT_DIR)/vexel.wasm
PLAYGROUND_TEMPLATE := $(OUT_DIR)/playground.template.html
PLAYGROUND := $(DOCS_DIR)/index.html

.PHONY: all clean

all: $(PLAYGROUND)

$(TARGET): $(SOURCES)
	$(EMXX) $(EMXXFLAGS) $(INCLUDES) $(SOURCES) $(EMFLAGS) -o $@

$(WASM): $(TARGET)
	@:

$(PLAYGROUND): $(PLAYGROUND_TEMPLATE) $(TARGET) $(WASM)
	@mkdir -p $(DOCS_DIR)
	VEXEL_BACKENDS="$(BACKEND_NAMES)" python3 $(OUT_DIR)/embed.py $(PLAYGROUND_TEMPLATE) $(TARGET) $(WASM) $(PLAYGROUND)

$(AUTO_REGISTER): $(BACKEND_HEADERS) Makefile
	@mkdir -p $(@D)
	@{ \
	  echo "/* Auto-generated by playground/Makefile. */"; \
	  echo "#include \"backend_registry.h\""; \
	  for name in $(BACKEND_NAMES); do \
	    echo "#include \"$$name""_backend.h\""; \
	  done; \
	  echo "namespace { struct AutoRegister { AutoRegister() {"; \
	  for name in $(BACKEND_NAMES); do \
	    echo "  vexel::register_backend_$$name();"; \
	  done; \
	  echo "} }; static AutoRegister auto_register; }"; \
	} > "$@"

clean:
	rm -f $(OUT_DIR)/vexel.js $(OUT_DIR)/vexel.wasm $(PLAYGROUND)
	rm -f $(AUTO_REGISTER)
